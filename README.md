# üõ†Ô∏è Customer Order Management API For Bike Store using Stored Procedures and Functions

## Overview

This project is a **Customer Order Management System For Bike Store** implemented using SQL **Stored Procedures** and **Functions**. It manages customers, orders, staff, products, and stores while ensuring efficient data handling through CRUD operations.

## Features

This repository provides SQL scripts to:

1. **Retrieve Data using Functions**:
   - Functions are used for SELECT queries.
   - If an ID is provided as a parameter, it retrieves the specific record.
   - If no parameter (or NULL) is passed, it returns all records.
     
2. **Delete Data using Stored Procedure**:
   - A stored procedure is implemented to delete records based on the given ID.
     
3. **Insert & Update Data using a Single Stored Procedure**:
   - If the given ID exists in the database, it updates the record.
   - If the ID does not exist, it inserts a new record.
   - If a NULL ID is provided, the ID is auto-generated by taking the highest existing ID and incrementing it by 1 (or set to 1 if the table is empty).
     
4. **Error Handling using Try-Catch**:
   - Implements structured error handling for troubleshooting and diagnostics.
     
5. **Parameter Usage**:
   - Uses SQL variables and parameters for flexible query execution.
     
6. **IF-ELSE Logic**:
   - Implemented wherever required to handle different execution conditions.

7. **Implementation**
   - Implemented the above in ASP.NET CORE
   - Dapper ORM is used
   - JWT Authentication used for each api endpoints
   - In ASP.NET Core, JSON serialization properties control how your C# models are converted to and from JSON. You typically use either:
     	- System.Text.Json (default in .NET Core 3.0+)
     	- Newtonsoft.Json (optional, needs package)
   - I have used [JsonPropertyName] from System.Text.Json. to send custom names (different from model property names) from an API to the frontend in ASP.NET Core

## Database Schema

The database consists of two main modules:

1. **Sales**:
   - Customers
   - Orders
   - Order Items
   - Stores
   - Staffs
2. **Production**:
   - Categories
   - Products
   - Stocks
   - Brands

### **Tables & Relationships**:

- **Customers** place multiple **Orders**.
- **Orders** contain multiple **Order Items**.
- **Orders** are processed by **Staffs** in **Stores**.
- **Stores** manage **Stock** of **Products**.
- **Products** belong to **Categories** and **Brands**.

![Group 1102](https://github.com/user-attachments/assets/5c965048-eaef-4d98-996e-5f1cb2c61283)

---
## üìå Database Schema, Database Table and Database Creation 
### 1. Create Database 
   ```sql
   create database APIcom;
   ```
### 2. Create Schemas 
   ```sql
   create schema sales;
   create schema production;
   ```
### 3. Create Database Tables 
#### 1. Table sales.stores
- The  sales.stores table includes the store‚Äôs information. Each store has a store name, contact information such as phone and email, and an address including street, city, state and zip code.
```sql
CREATE TABLE sales.stores (
	store_id INT PRIMARY KEY,
	store_name VARCHAR (255) NOT NULL,
	phone VARCHAR (25),
	email VARCHAR (255),
	street VARCHAR (255),
	city VARCHAR (255),
	state VARCHAR (10),
	zip_code VARCHAR (5)
);
```

#### 2. Table sales.staffs
- The  sales.staffs table stores the essential information of staffs including first name, last name. It also contains the communication information such as email and phone. A staff works at a store specified by the value in the store_id column. A store can have one or more staffs.
```sql
CREATE TABLE sales.staffs (
	staff_id INT PRIMARY KEY,
	first_name VARCHAR (50) NOT NULL,
	last_name VARCHAR (50) NOT NULL,
	email VARCHAR (255) NOT NULL UNIQUE,
	phone VARCHAR (25),
	store_id INT NOT NULL,
	FOREIGN KEY (store_id) 
        REFERENCES sales.stores (store_id) 
        ON DELETE CASCADE 
		ON UPDATE CASCADE,
);
```

#### 3. Table production.categories
- The production.categories table stores the bike‚Äôs categories such as children bicycles, comfort bicycles, and electric bikes.
```sql
CREATE TABLE production.categories (
	category_id INT PRIMARY KEY,
	category_name VARCHAR (255) NOT NULL
);
```

#### 4. Table production.brands
- The  production.brands table stores the brand‚Äôs information of bikes, for example, Electra, Haro, and Heller.
```sql
CREATE TABLE production.brands (
	brand_id INT PRIMARY KEY,
	brand_name VARCHAR (255) NOT NULL
);
```

#### 5. Table production.products
- The production.products table stores the product‚Äôs information such as name, brand, category, model year, and list price. Each product belongs to a brand specified by the brand_id column. Hence, a brand may have zero or many products. Each product also belongs a category specified by the category_id column. Also, each category may have zero or many products.
```sql
CREATE TABLE production.products (
	product_id INT PRIMARY KEY,
	product_name VARCHAR (255) NOT NULL,
	brand_id INT NOT NULL,
	category_id INT NOT NULL,
	model_year SMALLINT NOT NULL, --16 bits
	list_price DECIMAL (10, 2) NOT NULL,
	FOREIGN KEY (category_id) 
        REFERENCES production.categories (category_id) 
        ON DELETE CASCADE 
		ON UPDATE CASCADE,
	FOREIGN KEY (brand_id) 
        REFERENCES production.brands (brand_id) 
        ON DELETE CASCADE 
		ON UPDATE CASCADE
);
```

#### 6. Table sales.customers
- The  sales.customers table stores customer‚Äôs information including first name, last name, phone, email, street, city, and state.
```sql
CREATE TABLE sales.customers (
	customer_id INT PRIMARY KEY,
	first_name VARCHAR (255) NOT NULL,
	last_name VARCHAR (255) NOT NULL,
	phone VARCHAR (25),
	email VARCHAR (255) NOT NULL,
	street VARCHAR (255),
	city VARCHAR (50),
	state VARCHAR (25)
);
```

#### 7. Table sales.orders
- The sales.orders table stores the sales order‚Äôs header information including customer, order status, order date, required date, shipped date. It also stores the information on where the sales transaction was created (store) and who created it (staff). Each sales order has a row in the sales_orders table. A sales order has one or many line items stored in the sales.order_items table.
```sql
CREATE TABLE sales.orders (
	order_id INT PRIMARY KEY,
	customer_id INT,
	order_status tinyint NOT NULL, --8 bits
	-- Order status: 1 = Pending; 2 = Processing; 3 = Rejected; 4 = Completed
	order_date DATE NOT NULL,
	required_date DATE NOT NULL,
	shipped_date DATE,
	store_id INT NOT NULL,
	staff_id INT NOT NULL,
	FOREIGN KEY (customer_id) 
        REFERENCES sales.customers (customer_id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (store_id) 
        REFERENCES sales.stores (store_id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (staff_id) 
        REFERENCES sales.staffs (staff_id) 
        ON DELETE NO ACTION ON UPDATE NO ACTION
);
```

#### 8. Table sales.order_items
- The sales.order_items table stores the line items of a sales order. Each line item belongs to a sales order specified by the order_id column. A sales order line item includes product, order quantity, list price, and discount.
```sql
CREATE TABLE sales.order_items(
	order_id INT,
	item_id INT,
	product_id INT NOT NULL,
	quantity INT NOT NULL,
	list_price DECIMAL (10, 2) NOT NULL,
	discount DECIMAL (4, 2) NOT NULL DEFAULT 0,
	PRIMARY KEY (order_id, item_id),
	FOREIGN KEY (order_id) 
        REFERENCES sales.orders (order_id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (product_id) 
        REFERENCES production.products (product_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);
```

#### 9. Table production.stocks
- The production.stocks table stores the inventory information i.e. the quantity of a particular product in a specific store.
```sql
CREATE TABLE production.stocks (
	store_id INT,
	product_id INT,
	quantity INT,
	PRIMARY KEY (store_id, product_id),
	FOREIGN KEY (store_id) 
        REFERENCES sales.stores (store_id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (product_id) 
        REFERENCES production.products (product_id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);

```

## üìå Steps to Use a Stored Procedure with Input Parameters
### For Sales table
### 1Ô∏è‚É£ **Insert or Update Store Data Using a Single Stored Procedure**
This stored procedure tries to update an existing store's data based on store_id. If no rows are updated (i.e., the store_id does not exist), it inserts a new store with the next available store_id.
```sql
CREATE PROCEDURE inupStores 
	@store_id INT,
	@store_name VARCHAR (255),
	@phone VARCHAR (25),
	@email VARCHAR (255),
	@street VARCHAR (255),
	@city VARCHAR (255),
	@state VARCHAR (10),
	@zip_code VARCHAR (5)
AS 
BEGIN
	SET NOCOUNT ON; --prevent the row affected message from being displayed
	--First Try to update into stores if the id exists
	BEGIN TRY
		UPDATE sales.stores SET store_name=@store_name, 
		phone=@phone, email=@email, street=@street, city=@city, state=@state, zip_code=@zip_code WHERE store_id = @store_id;
	END TRY
	BEGIN CATCH
		PRINT 'Error Occurred!';
		PRINT ERROR_MESSAGE(); -- Get the error message
	END CATCH

	-- ====================================================================================================
	-- IF the update operation fails then try to insert the data
	-- such that if there exists records take the recent previous id and add it by 1 and set it as its id
	-- else i.e. there are no records then just set it as 1
	-- ====================================================================================================

	IF @@ROWCOUNT=0
	BEGIN TRY
		-- Declare variable
		DECLARE @PreviousId INT;

		-- Get the highest store_id
		SELECT @PreviousId = MAX(store_id) FROM sales.stores;

		-- Insert new store
		INSERT INTO sales.stores (store_id, store_name, phone, email, street, city, state, zip_code) 
		VALUES (
			COALESCE(@store_id, @PreviousId + 1, 1), --Coalesce(): Returns the first non-NULL value found.
			@store_name, @phone, @email, @street, @city, @state, @zip_code
		);

		PRINT 'Insert successful!';
	END TRY
	BEGIN CATCH
		PRINT 'Error Occurred!';
		PRINT ERROR_MESSAGE(); -- Get the error message
	END CATCH;

	ELSE
	BEGIN 
		PRINT 'update successful!';
	END
END
```

### 2Ô∏è‚É£ **Delete Store Data by ID**
This stored procedure deletes a store record based on its store_id.
```sql
CREATE PROCEDURE deleteStores 
	@store_id INT
AS 
BEGIN
	BEGIN TRY
		-- Delete the stores data using id
		DELETE FROM sales.stores WHERE store_id = @store_id;
		PRINT 'Delete successful!';
	END TRY
	BEGIN CATCH
		PRINT 'Error Occurred!';
		PRINT ERROR_MESSAGE(); -- Get the error message
	END CATCH;
END
```

### 3Ô∏è‚É£ **Select Store Data Based on store_id**
This function returns all store data or a specific store's data based on the provided store_id.
```sql
CREATE FUNCTION dbo.fn_getStores 
    (@store_id INT = NULL)  -- Default to NULL if not provided
RETURNS TABLE
AS
RETURN
    -- Select stores based on the value of @store_id
    SELECT store_id, store_name, phone, email, street, city, state, zip_code
    FROM sales.stores
    WHERE (@store_id IS NULL OR @store_id = 0 OR store_id = @store_id);
```

---

## üìã **Example Use Cases for the Stored Procedures and Functions**
### Below are the SQL commands to execute the stored procedures and functions:

#### Insert Data into Stores
```sql
EXEC inupStores 1,'ferrari','9860744627','ferrari@gmail.com','magam','Bhaktapur','Bagmati','1000'
```

#### Update Data for Store with ID = 1
```sql
EXEC inupStores 1,'lamborghini','9860744627','lamborghini@gmail.com','magam','Bhaktapur','Bagmati','2000'
```

#### Insert Data with Automatically Generated Store ID (Store ID = 2)
```sql
EXEC inupStores null,'Bentley','9860744627','Bentley@gmail.com','magam','Bhaktapur','Bagmati','3000'
```

#### Insert Data with Custom Store ID (Store ID = 109)
```sql
EXEC inupStores 109,'McLaren Speedtail','9860744627','McLaren@gmail.com','magam','Bhaktapur','Bagmati','4000'
```

#### Insert Data with Automatically Generated Store ID Based on Previous (Store ID = 110)
```sql
EXEC inupStores null,'Rimac Nevera','9860744627','Rimac@gmail.com','magam','Bhaktapur','Bagmati','5000'
```

#### Select All Store Data
```sql
select * from fn_getStores(null)
```

#### Select Store Data for Store with ID = 1
```sql
select * from fn_getStores(1)
```

#### Delete Store Data for Store with ID = 109
```sql
EXEC deleteStores 109
```
